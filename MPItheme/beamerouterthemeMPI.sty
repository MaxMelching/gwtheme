%% start of file `beamerouterthemeMPI.sty'.
% Author: Max Melching (m-melching@web.de), 2025
%
% Acknowledgements: this theme is a based on the UC Berkeley beamer theme. The file structure, however, follows the DTU template from https://gitlab.gbar.dtu.dk/latex/dtutemplates/-/tree/master/templates/Beamer

\mode<presentation>
% -- Purpose of this file: specify stuff that does not belong to content of the slide, such as headline, footline, background, frametitle


% -- Frametitle and headline ----------

\def\themeMPI@headerskip{0.0667\paperheight}  % Padding from top

% \defbeamertemplate{frametitle}{MPI}{\vskip\themeMPI@headerskip\insertframetitle}
% \defbeamertemplate{frametitle}{MPI}{\vskip\themeMPI@headerskip\insertframetitle\par\insertframesubtitle} 
% \defbeamertemplate{frametitle}{MPI}{\vskip\themeMPI@headerskip\insertframetitle{} \ -- \ \insertframesubtitle} 
% \defbeamertemplate{frametitle}{MPI}{\vskip\themeMPI@headerskip\insertframetitle{} \ -- \ \insertframesubtitle} 
% \defbeamertemplate{frametitle}{MPI}{\vskip\themeMPI@headerskip\insertframetitle{} \ -- \ {\usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle\strut\par}}

\defbeamertemplate*{frametitle}{MPI}{%
    \vskip\themeMPI@headerskip%
    \usebeamerfont{frametitle}\usebeamercolor[fg]{frametitle}%
    % \insertframetitle%
    \strut\insertframetitle%\strut\par%
    \ifx\insertframesubtitle\@empty%
    \else%
        % \ -- \ \insertframesubtitle%
        {%
            \usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}%
            \ -- \ \insertframesubtitle%
            % \strut\par%
        }%
    \fi%
    % -- Comment following line to hide framenumber
    % \hfill{\normalsize\insertframenumber/\inserttotalframenumber}%
}
% -- No need to use \setbeamertemplate{frametitle}[MPI]

% TODO: check if section is defined and use this? Or check frametitle first and then section?



\RequirePackage{calc}  % For length calculations to work

% -- Note: for this particular package, paths are strange because we compile from main.tex
\RequirePackage[
    % templatefile="MPItheme/generic_template.txt",
    % templatefile="MPItheme/eccentric_template.txt",
    % templatefile="MPItheme/generic_template_w_noise.txt",
    % -- Fancy:
    templatefile="MPItheme/generic_template_no_noise.txt",
    backgroundsignal="MPItheme/generic_template_w_noise.txt",
    % 
    % templatefile="MPItheme/eccentric_template_no_noise.txt",
    % backgroundsignal="MPItheme/eccentric_template_w_noise.txt",
    % -- General stuff
    leftpadding=0.6\paperwidth,
    rightpadding=0.006\paperwidth,
    signalheight=2.4em,
    % -- Activate following two for above code to be used
    declaretitlebox=false,
    signalupshift=-0.0667\paperheight-2.25em,  % \themeMPI@headerskip minus estimate of font height
]{gwbar}



\RequirePackage{tikz}

\tikzset{
    gwbar@linelayerone/.style={
        fg,
        smooth,
        thick,
	},
    gwbar@linelayertwo/.style={
        % opacity=0.2,
        bg!50,  % Nicer for transparent titlebox
        % gray!50!bg,  % Nicer for gwbar titlebox (default)
		smooth,
        thick,
	},
}


\setbeamertemplate{headline}[gwbar]  % -- Requires frametitle that is transparent, otherwise invisible

% -- For use of default frametitle with GW, activate following template
% \setbeamertemplate{frametitle}[gwbar]


% -- Background ----------

% \def\themeMPI@footupshift{0.025\paperheight}
% \def\themeMPI@footvertshift{0.025\paperheight}
\newlength{\themeMPI@footupshift}
\newlength{\themeMPI@footvertshift}
\setlength{\themeMPI@footupshift}{0.025\paperheight}
\setlength{\themeMPI@footvertshift}{0.025\paperheight}

\pgfdeclareimage[height=0.1\paperheight]{themeMPI@background_logo}{logos/MPI-AEI_wide_E_neg_cmyk}  % White goes best with most colors


\defbeamertemplate*{background}{MPI}{%
    \begin{tikzpicture}[overlay,remember picture]%
      \fill[fg] (current page.south west) -- +(0, 0.08\paperheight) -- +(\paperwidth, 0.16\paperheight) -- (current page.south east) -- cycle;

    \node[anchor=south east,inner sep=0pt,draw=none,xshift=-\themeMPI@footvertshift,yshift=\themeMPI@footupshift] at (current page.south east) {\pgfuseimage{themeMPI@background_logo}};

    % \node[anchor=south west,inner sep=0pt,draw=none,xshift=0.025\paperheight,yshift=0.025\paperheight] at (current page.south west) {\textcolor{bg}{\sffamily\bfseries\small\MakeUppercase\insertauthor}};
    % % \node[anchor=south west,inner sep=0pt,draw=none,xshift=0.025\paperheight,yshift=0.025\paperheight] at (current page.south west) {\textcolor{bg}{\sffamily\bfseries\insertframenumber/\inserttotalframenumber \ \normalsize\MakeUppercase\insertauthor}};
    
    % \node[anchor=south,inner sep=0pt,draw=none,xshift=-0.025\paperheight,yshift=0.025\paperheight] at (current page.south) {\textcolor{bg}{\sffamily\bfseries\small\insertframenumber/\inserttotalframenumber}};
    \end{tikzpicture}%
}
% -- No need to use \setbeamertemplate{background}[MPI]


% -- Footline and navigation symbols ----------
\setbeamertemplate{navigation symbols}{}


% \defbeamertemplate*{footline}{%
%     \vskip0.15\paperheight%
% }

% \defbeamertemplate*{footline}{}  % Don't see how previous one makes a difference

% \defbeamertemplate*{footline}{%
%   \leavevmode%
%   \hbox{%
%   \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,left]{footline}%{author in head/foot}%
%     \usebeamerfont{author in head/foot}%
%     \hspace\themeMPI@footvertshift%\vspace\themeMPI@footupshift%
%     \strut\MakeUppercase\insertshortauthor{}\strut\par%
%     % \vspace\themeMPI@footupshift%
%   \end{beamercolorbox}%
%   \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,left]{footline}%{framenumber in head/foot}%
%     \usebeamerfont{framenumber in head/foot}%
%     % \hspace\themeMPI@footvertshift%\vspace\themeMPI@footupshift%
%     \insertframenumber{}/\inserttotalframenumber{}%
%   \end{beamercolorbox}%
%   \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,right]{author in head/foot}%
%     % 
%   \end{beamercolorbox}%
%   }%
%   \vskip0pt%
% }


\RequirePackage{appendixnumberbeamer}
\RequirePackage{etoolbox}

% -- Initialize a toggle for appendix
\newtoggle{inappendix}
\settoggle{inappendix}{false}

% -- Patch the \appendix command to set the toggle to true
\pretocmd{\appendix}{\global\toggletrue{inappendix}}{}{}
% -> luckily, is still added when appendixnumberbeamer is loaded again e.g. in main document


\defbeamertemplate*{footline}{MPI}{%
  \leavevmode%
  \hbox{%
  \begin{beamercolorbox}[wd=.5\paperwidth,ht=2.25ex,dp=1ex]{footline}%
    \hspace\themeMPI@footvertshift
    {%
        \usebeamerfont{author in head/foot}%
        % \MakeUppercase\insertauthor%
        \MakeUppercase\insertshortauthor% Does not actually make stuff uppercase, for some reason -> thus, if you intend to use this, define the short author with MakeUppercase already
    }%
    \iftoggle{inappendix}{%
        % -- Do not show framenumber in appendix (where progressbar also stops)
    }{%
    \hfill%
    {%
        \usebeamerfont{framenumber in head/foot}%
        \insertframenumber/\inserttotalframenumber%
        }%
    }%
    \vspace{0.5\themeMPI@footupshift}%
  \end{beamercolorbox}%
  \begin{beamercolorbox}[wd=.5\paperwidth,ht=2.25ex,dp=1ex]{footline}%
    % \hspace\themeMPI@footvertshift%\vspace\themeMPI@footupshift%
  \end{beamercolorbox}%
  }%
  \vskip0pt%
}
% -- No need to use \setbeamertemplate{footline}[MPI]



\mode
<all>