%% start of file `beamerouterthemeGW.sty'.
% Author: Max Melching (m-melching@web.de), 2025
%
% Acknowledgements: this theme is a based on the UC Berkeley beamer theme. The file structure, however, follows the DTU template from https://gitlab.gbar.dtu.dk/latex/dtutemplates/-/tree/master/templates/Beamer

\mode<presentation>
% -- Purpose of this file: specify stuff that does not belong to content of the slide, such as headline, footline, background, frametitle


% -- Frametitle and headline ----------

\def\themeGW@headerskip{0.0667\paperheight}  % Padding from top

% \defbeamertemplate{frametitle}{GW}{\vskip\themeGW@headerskip\insertframetitle}
% \defbeamertemplate{frametitle}{GW}{\vskip\themeGW@headerskip\insertframetitle\par\insertframesubtitle} 
% \defbeamertemplate{frametitle}{GW}{\vskip\themeGW@headerskip\insertframetitle{} \ -- \ \insertframesubtitle} 
% \defbeamertemplate{frametitle}{GW}{\vskip\themeGW@headerskip\insertframetitle{} \ -- \ \insertframesubtitle} 
% \defbeamertemplate{frametitle}{GW}{\vskip\themeGW@headerskip\insertframetitle{} \ -- \ {\usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}\insertframesubtitle\strut\par}}

\defbeamertemplate*{frametitle}{GW}{%
    \vskip\themeGW@headerskip%
    \usebeamerfont{frametitle}\usebeamercolor[fg]{frametitle}%
    % \insertframetitle%
    \strut\insertframetitle{} \strut%\par%
    \ifx\insertframesubtitle\@empty%
    \else%
        % \ -- \ \insertframesubtitle%
        {%
            \usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}%
            \ \textbf{---} \ \insertframesubtitle%
            % \ \textbullet \ \insertframesubtitle%
            % \strut\par%
        }%
    \fi%
    % -- Comment following line to hide framenumber
    % \hfill{\scriptsize\insertframenumber/\inserttotalframenumber}%
}
% -- No need to use \setbeamertemplate{frametitle}[GW]

% TODO: check if section is defined and use this? Or check frametitle first and then section?

\defbeamertemplate{frametitle}{GWsection}{%
    \vskip\themeGW@headerskip%
    \usebeamerfont{frametitle}\usebeamercolor[fg]{frametitle}%
    % \insertframetitle%
    \ifx\insertframetitle\@empty%
    \strut\insertsection%
    \else%
    \strut\insertframetitle%
    \fi%
    {%
        \usebeamerfont{framesubtitle}\usebeamercolor[fg]{framesubtitle}%
        \ifx\insertframesubtitle\@empty%
            \ifx\insertsubsection\@empty%
            \else%
                \ \textbf{---} \ \insertsubsection%
                % \ \textbullet \ \insertsubsection%
            \fi%
        \else%
            \ \textbf{---} \ \insertframesubtitle%
            % \ \textbullet \ \insertframesubtitle%
        \fi%
    }%
    % -- Comment following line to hide framenumber
    % \hfill{\scriptsize\insertframenumber/\inserttotalframenumber}%
}

% -- Not the default. To activate, uncomment next line
% \setbeamertemplate{frametitle}[GWsection]


% TODO: rather start new line for subsection?



\RequirePackage{calc}  % For length calculations to work

% -- Note: for this particular package, paths are strange because we compile from main.tex
\RequirePackage[
    % templatefile="GWtheme/generic_template.txt",
    % templatefile="GWtheme/eccentric_template.txt",
    % templatefile="GWtheme/generic_template_w_noise.txt",
    % -- Fancy:
    % templatefile="GWtheme/generic_template_no_noise.txt",
    templatefile="GWtheme/generic_template_no_noise_whitened.txt",
    backgroundsignal="GWtheme/generic_template_w_noise.txt",
    % 
    % templatefile="GWtheme/eccentric_template_no_noise.txt",
    % backgroundsignal="GWtheme/eccentric_template_w_noise.txt",
    % -- General stuff
    leftpadding=0.6\paperwidth,
    rightpadding=0.006\paperwidth,
    signalheight=20pt,  % Using em here is bad, has different values depending on fontsize, i.e. in particular different when using in frametitle or headline
    % -- Activate following two for above code to be used
    declaretitlebox=false,
    signalupshift=-0.0667\paperheight-24pt,  % \themeGW@headerskip minus estimate of font height. Only use if gwbar is added to beamertheme
% ]{gwbar_v1}
]{gwbar}



\RequirePackage{tikz}

\tikzset{
    gwbar@linelayerone/.style={
        fg,
        smooth,
        thick,
	},
    gwbar@linelayertwo/.style={
        % opacity=0.2,
        bg!50,  % Nicer for transparent titlebox
        % gray!50!bg,  % Nicer for gwbar titlebox (default)
		smooth,
        thick,
	},
}


\setbeamertemplate{headline}[gwbar]  % -- Requires frametitle that is transparent, otherwise invisible
% \addtobeamertemplate{frametitle}{}{\drawgwbar}  % For use with gwbar, in case you do not want to use above frametitle template and headline is hidden behind frametitle


% -- For use of default frametitle with GW, activate following template
% \setbeamertemplate{frametitle}[gwbar]


% -- Background ----------

% \def\themeGW@footupshift{0.025\paperheight}
% \def\themeGW@footvertshift{0.025\paperheight}
\newlength{\themeGW@footupshift}
\newlength{\themeGW@footvertshift}
\setlength{\themeGW@footupshift}{0.025\paperheight}
\setlength{\themeGW@footvertshift}{0.025\paperheight}


\defbeamertemplate*{background}{GW}{%
    \begin{tikzpicture}[overlay,remember picture]%
        \fill[fg] (current page.south west) -- +(0, 0.08\paperheight) -- +(\paperwidth, 0.16\paperheight) -- (current page.south east) -- cycle;

        % \node[anchor=south east,inner sep=0pt,draw=none,xshift=-\themeGW@footvertshift,yshift=\themeGW@footupshift] at (current page.south east) {\insertlogo};
        % TODO: figure out why this inserts two pictures on normal frame
        \node[anchor=south east,inner sep=0pt,draw=none,xshift=-\themeGW@footvertshift,yshift=\themeGW@footupshift] at (current page.south east) {\pgfuseimage{logo}};

    % \node[anchor=south west,inner sep=0pt,draw=none,xshift=0.025\paperheight,yshift=0.025\paperheight] at (current page.south west) {\textcolor{bg}{\sffamily\bfseries\small\MakeUppercase\insertauthor}};
    % % \node[anchor=south west,inner sep=0pt,draw=none,xshift=0.025\paperheight,yshift=0.025\paperheight] at (current page.south west) {\textcolor{bg}{\sffamily\bfseries\insertframenumber/\inserttotalframenumber \ \normalsize\MakeUppercase\insertauthor}};
    
    % \node[anchor=south,inner sep=0pt,draw=none,xshift=-0.025\paperheight,yshift=0.025\paperheight] at (current page.south) {\textcolor{bg}{\sffamily\bfseries\small\insertframenumber/\inserttotalframenumber}};
    \end{tikzpicture}%
}
% -- No need to use \setbeamertemplate{background}[GW]


% -- Second template, with fancy pattern
\usetikzlibrary{decorations.markings}
\usetikzlibrary{calc}

\def\themeGW@squaresize{4pt}

\tikzset{
    fillsquare1/.style={
        black!12!fg,
        line width=0.8pt,
    },
    fillsquarepath1/.style={
        fg,
        postaction=decorate,
        decoration={
            markings,
            mark = between positions 0 and 1 step 1/8 with {
                \draw[fillsquare1] (-\themeGW@squaresize, -\themeGW@squaresize) rectangle (\themeGW@squaresize, \themeGW@squaresize);
            },
        },
    },
    fillsquare2/.style={
        % fg!90!gray,
        fg!92!white,
        line width=0.8pt,
        },
    fillsquarepath2/.style={
        fg,
        postaction=decorate,
        decoration={
            markings,
            mark = between positions 0 and 1 step 1/8 with {
                \draw[fillsquare2] (-\themeGW@squaresize, -\themeGW@squaresize) rectangle (\themeGW@squaresize, \themeGW@squaresize);
            },
        },
    },
}


\newlength{\themeGW@MeanFootHeight}
% \setlength{\themeGW@MeanFootHeight}{0.08\paperwidth}
\setlength{\themeGW@MeanFootHeight}{0.1\paperwidth}


\newlength{\themeGW@PatternCommonShift}
\newlength{\themeGW@PatternRelativeShift}

\setlength{\themeGW@PatternCommonShift}{0pt}
\setlength{\themeGW@PatternRelativeShift}{-0.5\themeGW@MeanFootHeight}  % Roughly matches website


% \newlength{\themeGW@footupshift}
% \newlength{\themeGW@footvertshift}
% \setlength{\themeGW@footupshift}{0.25\themeGW@MeanFootHeight}
% \setlength{\themeGW@footvertshift}{0.25\themeGW@MeanFootHeight}


\defbeamertemplate{background}{GWWithPattern}{%
    \begin{tikzpicture}[overlay,remember picture]%
        \clip (current page.south west) -- +(0, 0.85\themeGW@MeanFootHeight) -- +(\paperwidth, 1.15\themeGW@MeanFootHeight) -- (current page.south east) -- cycle;
        \fill[fg] (current page.south west) -- +(0, \themeGW@MeanFootHeight+5pt) -- +(\paperwidth, \themeGW@MeanFootHeight+5pt) -- (current page.south east) -- cycle;

    
        \begin{scope}[
            shift=(current page.south west),
        ]
            \pgfmathsetmacro{\LastIndex}{\paperwidth/(2*\themeGW@MeanFootHeight)}
            \pgfmathsetmacro{\LastIndex}{2*\LastIndex+1}  % +1 to make sure we do not encounter rounding errors
            \pgfmathround{\LastIndex}
            \let\LastIndexInt\pgfmathresult
            \foreach \i in {0, 2, 4, ..., \LastIndexInt} {
                \draw[
                    fillsquarepath1,
                    shift={(\i*\themeGW@MeanFootHeight + \themeGW@PatternCommonShift, 0)},
                ] (0, 0)
                    -- ++(\themeGW@MeanFootHeight, \themeGW@MeanFootHeight)
                    -- ++(\themeGW@MeanFootHeight, -\themeGW@MeanFootHeight);
                
                \draw[
                    fillsquarepath2,
                    shift={(\i*\themeGW@MeanFootHeight + \themeGW@PatternCommonShift + \themeGW@PatternRelativeShift, 0)},
                ] (0, 0)
                    -- ++(\themeGW@MeanFootHeight, \themeGW@MeanFootHeight)
                    -- ++(\themeGW@MeanFootHeight, -\themeGW@MeanFootHeight);
            }
        \end{scope}
            
        % -- Order matters, we want this in foreground
        % \node[draw=none,anchor=south east,inner sep=0pt,xshift=-\themeGW@footvertshift,yshift=\themeGW@footupshift] at (current page.south east) {\insertlogo};
        \node[draw=none,anchor=south east,inner sep=0pt,xshift=-\themeGW@footvertshift,yshift=\themeGW@footupshift] at (current page.south east) {\pgfuseimage{logo}};
    \end{tikzpicture}%
}

% -- Not the default. To activate, uncomment next line
% \setbeamertemplate{background}[GWWithPattern]


% -- Footline and navigation symbols ----------
\setbeamertemplate{navigation symbols}{}


% \defbeamertemplate*{footline}{%
%     \vskip0.15\paperheight%
% }

% \defbeamertemplate*{footline}{}  % Don't see how previous one makes a difference

% \defbeamertemplate*{footline}{%
%   \leavevmode%
%   \hbox{%
%   \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,left]{footline}%{author in head/foot}%
%     \usebeamerfont{author in head/foot}%
%     \hspace\themeGW@footvertshift%\vspace\themeGW@footupshift%
%     \strut\MakeUppercase\insertshortauthor{}\strut\par%
%     % \vspace\themeGW@footupshift%
%   \end{beamercolorbox}%
%   \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,left]{footline}%{framenumber in head/foot}%
%     \usebeamerfont{framenumber in head/foot}%
%     % \hspace\themeGW@footvertshift%\vspace\themeGW@footupshift%
%     \insertframenumber{}/\inserttotalframenumber{}%
%   \end{beamercolorbox}%
%   \begin{beamercolorbox}[wd=.333333\paperwidth,ht=2.25ex,dp=1ex,right]{author in head/foot}%
%     % 
%   \end{beamercolorbox}%
%   }%
%   \vskip0pt%
% }


\RequirePackage{appendixnumberbeamer}
\RequirePackage{etoolbox}

% -- Initialize a toggle for appendix
\newtoggle{inappendix}
\settoggle{inappendix}{false}

% -- Patch the \appendix command to set the toggle to true
\pretocmd{\appendix}{\global\toggletrue{inappendix}}{}{}
% -> luckily, is still added when appendixnumberbeamer is loaded again e.g. in main document


\defbeamertemplate*{footline}{GW}{%
  \leavevmode%
  \hbox{%
  \begin{beamercolorbox}[wd=.5\paperwidth,ht=2.25ex,dp=1ex]{footline}%
    \hspace\themeGW@footvertshift%
    {%
        \usebeamerfont{author in head/foot}%
        % \MakeUppercase\insertauthor%
        \MakeUppercase\insertshortauthor% Does not actually make stuff uppercase, for some reason -> thus, if you intend to use this, define the short author with MakeUppercase already
    }%
    \iftoggle{inappendix}{%
        % -- Do not show framenumber in appendix (where progressbar also stops)
    }{%
    \hfill%
    {%
        \usebeamerfont{framenumber in head/foot}%
        \insertframenumber/\inserttotalframenumber%
        }%
    }%
  \end{beamercolorbox}%
  \begin{beamercolorbox}[wd=.5\paperwidth,ht=2.25ex,dp=1ex]{footline}%
    % \hspace\themeGW@footvertshift%\vspace\themeGW@footupshift%
  \end{beamercolorbox}%
  }%
  \vspace{\themeGW@footupshift}%
}
% -- No need to use \setbeamertemplate{footline}[GW]


\mode
<all>